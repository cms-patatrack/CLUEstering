
name: Test serial installation without boost preinstalled

# The workflow gets triggered by pushes and pull requests
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with: 
        submodules: true

    - name: Package the library inside a tarball
      working-directory: ${{github.workspace}}
      run: |
        ./packaging.sh

    - name: Pull Docker image from Docker Hub
      run: docker pull sbalducci00/sbaldu:cluestering_arch.serial

    - name: Run commands inside Docker container
      run: |
        docker run -v $(pwd)/dist:/app -w /app \
        sbalducci00/sbaldu:cluestering_arch.serial bash -c '
          tar -xvf CLUEstering*.tar.gz
          rm *.tar.gz
          cd CLUEstering*
          pip install .
        '

    - name: Check number of modules
      run: |
        ls -l dist/CLUEstering*/build/lib/CLUEstering/lib | wc -l > output.txt
        if [[ $(cat output.txt) == 2 ]]
        then
          echo "Correct: Both and only the convolutional and serial modules are generated"
        else
          exit 1
        fi
